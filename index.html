<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>BPMN Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/diagram-js.css">
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/bpmn-font/css/bpmn.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }
    #controls {
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #xmlInput {
      width: 100%;
      height: 200px;
      font-family: monospace;
      box-sizing: border-box;
      padding: 10px;
      transition: background-color 0.3s, color 0.3s;
      border: none;
      resize: vertical;
    }
    #buttons {
      display: flex;
      gap: 10px;
      padding: 10px;
      flex-wrap: wrap;
    }
    #canvas {
      height: 65%;
      width: 100%;
      border-top: 1px solid #ccc;
      background-color: #fff;
      transition: background-color 0.3s, border-color 0.3s;
    }
    #themeToggle {
      cursor: pointer;
      font-size: 20px;
      background: none;
      border: none;
    }
    #errorLog {
      padding: 10px;
      font-family: monospace;
      color: red;
      white-space: pre-wrap;
    }

    body.dark {
      background-color: #1e1e1e;
      color: #f0f0f0;
    }
    body.dark #canvas {
      background-color: #2c2c2c;
      border-color: #444;
    }
    body.dark #xmlInput {
      background-color: #333;
      color: #f8f8f8;
      border: 1px solid #555;
    }
    body.dark #errorLog {
      color: #ff6b6b;
    }
    button {
      padding: 6px 12px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <div id="controls">
    <strong>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ XML-–∫–æ–¥ —Å—Ö–µ–º—ã –Ω–∏–∂–µ:</strong>
    <button id="themeToggle">üåô</button>
  </div>

  <textarea id="xmlInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ XML —Å—é–¥–∞..."></textarea>

  <div id="buttons">
    <button id="downloadBPMN">–°–∫–∞—á–∞—Ç—å .bpmn</button>
    <button id="downloadSVG">–°–∫–∞—á–∞—Ç—å SVG</button>
    <button id="downloadPNG">–°–∫–∞—á–∞—Ç—å PNG</button>
    <button id="downloadJPEG">–°–∫–∞—á–∞—Ç—å JPEG</button>
  </div>

  <div id="errorLog"></div>
  <div id="canvas"></div>

  <script src="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-modeler.development.js"></script>
  <script>
    const bpmnModeler = new BpmnJS({ container: '#canvas' });
    const xmlInput = document.getElementById('xmlInput');
    const errorLog = document.getElementById('errorLog');

    let debounceTimer;
    xmlInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(renderDiagram, 500);
    });

    async function renderDiagram() {
      const xml = xmlInput.value;
      errorLog.textContent = '';
      if (!xml.trim()) return;

      try {
        await bpmnModeler.importXML(xml);
        const canvas = bpmnModeler.get('canvas');
        canvas.zoom('fit-viewport');
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ XML:', err);
        errorLog.textContent = `–û—à–∏–±–∫–∞: ${err.message}`;
      }
    }

    document.getElementById('themeToggle').addEventListener('click', () => {
      document.body.classList.toggle('dark');
    });

    function download(data, filename, type) {
      const blob = new Blob([data], { type });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    document.getElementById('downloadBPMN').addEventListener('click', async () => {
      try {
        const { xml } = await bpmnModeler.saveXML({ format: true });
        download(xml, 'diagram.bpmn', 'application/xml');
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ BPMN: ' + err.message);
      }
    });

    document.getElementById('downloadSVG').addEventListener('click', async () => {
      try {
        const { svg } = await bpmnModeler.saveSVG();
        download(svg, 'diagram.svg', 'image/svg+xml');
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ SVG: ' + err.message);
      }
    });

    document.getElementById('downloadPNG').addEventListener('click', async () => {
      try {
        const { svg } = await bpmnModeler.saveSVG();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        const svgBlob = new Blob([svg], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(svgBlob);
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          canvas.toBlob(blob => {
            const pngUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = pngUrl;
            a.download = 'diagram.png';
            a.click();
            URL.revokeObjectURL(pngUrl);
          });
        };
        img.src = url;
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ PNG: ' + err.message);
      }
    });

    document.getElementById('downloadJPEG').addEventListener('click', async () => {
      try {
        const { svg } = await bpmnModeler.saveSVG();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        const svgBlob = new Blob([svg], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(svgBlob);
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          canvas.toBlob(blob => {
            const jpegUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = jpegUrl;
            a.download = 'diagram.jpeg';
            a.click();
            URL.revokeObjectURL(jpegUrl);
          }, 'image/jpeg');
        };
        img.src = url;
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ JPEG: ' + err.message);
      }
    });
  </script>
</body>
</html>
