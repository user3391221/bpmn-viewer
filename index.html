<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>BPMN Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/diagram-js.css">
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/bpmn-font/css/bpmn.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }
    #controls {
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #xmlInput {
      width: 100%;
      height: 200px;
      font-family: monospace;
      box-sizing: border-box;
      padding: 10px;
      border: none;
      resize: vertical;
      transition: background-color 0.3s, color 0.3s;
    }
    #buttons {
      display: flex;
      gap: 10px;
      padding: 10px;
      flex-wrap: wrap;
    }
    #canvas {
      height: 60%;
      width: 100%;
      border-top: 1px solid #ccc;
      background-color: #fff;
      transition: background-color 0.3s, border-color 0.3s;
    }
    #themeToggle {
      cursor: pointer;
      font-size: 20px;
      background: none;
      border: none;
    }
    #errorLog {
      padding: 10px;
      font-family: monospace;
      font-size: 14px;
      color: red;
      white-space: pre-wrap;
      border-top: 1px solid #ccc;
      min-height: 25px;
    }
    body.dark {
      background-color: #1e1e1e;
      color: #f0f0f0;
    }
    body.dark #canvas {
      background-color: #2c2c2c;
      border-color: #444;
    }
    body.dark #xmlInput {
      background-color: #333;
      color: #f8f8f8;
      border: 1px solid #555;
    }
    body.dark #errorLog {
      color: #ff6b6b;
      border-color: #444;
    }
    button {
      padding: 6px 12px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    /* –°–∏–Ω—è—è –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ */
    #exitSubprocess {
      display: none; 
      background-color: #1976d2; /* –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π —Å–∏–Ω–∏–π */
      color: #fff;
      font-weight: bold;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    #exitSubprocess:hover {
      background-color: #0d47a1; /* —Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    }
  </style>
</head>
<body>

  <div id="controls">
    <strong>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ XML-–∫–æ–¥ —Å—Ö–µ–º—ã –Ω–∏–∂–µ:</strong>
    <button id="themeToggle">üåô</button>
  </div>

  <textarea id="xmlInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ XML —Å—é–¥–∞..."></textarea>

  <div id="buttons">
    <button id="downloadBPMN">–°–∫–∞—á–∞—Ç—å .bpmn</button>
    <button id="downloadSVG">–°–∫–∞—á–∞—Ç—å SVG</button>
    <button id="downloadPNG">–°–∫–∞—á–∞—Ç—å PNG</button>
    <button id="downloadJPEG">–°–∫–∞—á–∞—Ç—å JPEG</button>
    <button id="exitSubprocess">–í—ã–π—Ç–∏ –∏–∑ –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å–∞</button>
  </div>

  <div id="errorLog">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è...</div>
  <div id="canvas"></div>

  <script src="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-modeler.development.js"></script>
  <script>
    const bpmnModeler = new BpmnJS({
      container: '#canvas',
      keyboard: { bindTo: window }
    });

    const xmlInput = document.getElementById('xmlInput');
    const errorLog = document.getElementById('errorLog');
    const exitButton = document.getElementById('exitSubprocess');
    const eventBus = bpmnModeler.get('eventBus');

    let debounceTimer;
    xmlInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(renderDiagram, 500);
    });

    async function renderDiagram() {
      const xml = xmlInput.value;
      errorLog.textContent = '';
      if (!xml.trim()) return;

      try {
        await bpmnModeler.importXML(xml);
        const canvas = bpmnModeler.get('canvas');
        canvas.zoom('fit-viewport');
        errorLog.textContent = '–û—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.';

        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å
        eventBus.on('root.set', ({ element }) => {
          if (element.type === 'bpmn:SubProcess') {
            exitButton.style.display = 'inline-block';
          } else {
            exitButton.style.display = 'none';
          }
        });

      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ XML:', err);
        errorLog.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
      }
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è XML –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
    bpmnModeler.on('commandStack.changed', async () => {
      try {
        const { xml } = await bpmnModeler.saveXML({ format: true });
        xmlInput.value = xml;
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ XML:', err);
      }
    });

    // –ö–Ω–æ–ø–∫–∞ "–í—ã–π—Ç–∏ –∏–∑ –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å–∞"
    exitButton.addEventListener('click', async () => {
      try {
        const { xml } = await bpmnModeler.saveXML({ format: true });
        await bpmnModeler.importXML(xml);
        const canvas = bpmnModeler.get('canvas');
        canvas.zoom('fit-viewport');
        errorLog.textContent = '–í–æ–∑–≤—Ä–∞—Ç –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ö–µ–º–µ –≤—ã–ø–æ–ª–Ω–µ–Ω.';
        exitButton.style.display = 'none';
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ö–µ–º–µ:', err);
        errorLog.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
      }
    });

    // –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
    document.getElementById('themeToggle').addEventListener('click', () => {
      document.body.classList.toggle('dark');
    });

    function download(data, filename, type) {
      const blob = new Blob([data], { type });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    document.getElementById('downloadBPMN').addEventListener('click', async () => {
      try {
        const { xml } = await bpmnModeler.saveXML({ format: true });
        download(xml, 'diagram.bpmn', 'application/xml');
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ BPMN: ' + err.message);
      }
    });

    document.getElementById('downloadSVG').addEventListener('click', async () => {
      try {
        const { svg } = await bpmnModeler.saveSVG();
        download(svg, 'diagram.svg', 'image/svg+xml');
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ SVG: ' + err.message);
      }
    });

    document.getElementById('downloadPNG').addEventListener('click', async () => {
      try {
        const { svg } = await bpmnModeler.saveSVG();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        const svgBlob = new Blob([svg], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(svgBlob);
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          canvas.toBlob(blob => {
            const pngUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = pngUrl;
            a.download = 'diagram.png';
            a.click();
            URL.revokeObjectURL(pngUrl);
          });
        };
        img.src = url;
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ PNG: ' + err.message);
      }
    });

    document.getElementById('downloadJPEG').addEventListener('click', async () => {
      try {
        const { svg } = await bpmnModeler.saveSVG();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        const svgBlob = new Blob([svg], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(svgBlob);
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          canvas.toBlob(blob => {
            const jpegUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = jpegUrl;
            a.download = 'diagram.jpeg';
            a.click();
            URL.revokeObjectURL(jpegUrl);
          }, 'image/jpeg');
        };
        img.src = url;
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ JPEG: ' + err.message);
      }
    });
  </script>
</body>
</html>
